<!doctype html>

<head>
    <meta charset="utf-8">
    <title> Test DataTable</title>
    <script type="text/javascript" src="https://cdn.webix.com/edge/webix.js"></script>
    <script type="text/javascript" src="./data.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.webix.com/edge/webix.css">
    <style type="text/css">
        .webix_cell .colored {
            width: 50px;
            height: 50px;
        }
    </style>
</head>

<body>
    <div id="test"></div>
    <script type="text/javascript" charset="utf-8">
        webix.DataDriver.myJSON = webix.extend({
            getRecords: function (data) {
                return data.records;
            }
        }, webix.DataDriver.json);

        webix.ui({
            rows: [{
                cols: [
                    {
                        view: "button", value: "Add", width: 100, click: function () {
                            $$("data").add({
                                "isActive": true,
                                "eyeColor": "blue",
                                "fname": "Allon",
                                "picture": "http://placehold.it/32x32",
                                "registered": new Date(),
                                "friends": [],
                                "balance": 1631.09,
                                "age": 56,
                                "phone": "+1 (983) 551-3630",
                                "address": "700 Xolp Street, Ders, Texas, 4764",
                                "company": "ASAA"
                            });
                        }
                    },
                    {
                        view: "text",
                        on: {
                            onTimedKeyPress() {
                                const input = this.getValue().toLowerCase();

                                $$("data").filter(function (obj) {
                                    let found = false;
                                    for (let field in obj) {
                                        if (obj[field]) {
                                            if (typeof obj[field] === "string") {
                                                found = obj[field].toLowerCase().indexOf(input) !== -1;
                                            } else if (typeof obj[field] === "number") {
                                                found = obj[field] == input;
                                            } else if (obj[field] instanceof Date) {
                                                webix.i18n.fullDateFormatStr(obj[field]).indexOf(input) !== -1;
                                            }

                                            if (found) return found;
                                        }
                                    }
                                    return found;
                                });
                            }
                        }
                    },
                ]
            },
            {
                view: "datatable",
                datatype: "myJSON",
                id: "data",
                data: data,
                select: true,
                drag: true,
                editable: true,
                editaction: "dblclick",
                scheme: {
                    $init: function (obj) {
                        obj.registered = webix.i18n.parseFormatDate(obj.registered);
                        if (obj.lname) {
                            obj.name = obj.fname + "" + obj.lname
                        }
                        else obj.name = obj.fname
                    }
                },
                onClick: {
                    "wxi-trash": function (e, id) {
                        this.remove(id);
                        return false;
                    },
                },
                on: {
                    onAfterEditStop(state, editor, ignoreUpdate) {
                        if (editor.column == "name") {
                            let parts = state.value.split(" ");
                            editor.fname = parts[0];
                            editor.lname = parts.slice(1).join();
                            console.log(editor.lname)
                        }

                    },
                    onBeforeEditStop(state, editor, ignoreUpdate) {
                        if (editor.column == "name" && state.value == "") {
                            return false
                        }

                    },
                },
                columns: [
                    { id: "id", header: "#", sort: "int" },
                    { id: "isActive", header: { content: "masterCheckbox" }, template: "{common.checkbox()}" },
                    { id: "picture", header: "<span class='webix_icon wxi-user'></span>", template: "<img src='#picture#'/>" },
                    { id: "name", header: "Name", sort: "text", editor: "text", },
                    { id: "age", header: "Age", sort: "int", editor: "text" },
                    { id: "eyeColor", header: "Eye", sort: "text", editor: "color", template: "<div class='colored' style='background-color:#eyeColor#'></div>" },
                    { id: "company", header: "Company", sort: "string", editor: "text" },
                    { id: "phone", header: "Phone", sort: "string", editor: "text" },
                    { id: "address", header: "Address", fillspace: true, sort: "string", editor: "text" },
                    { id: "balance", header: "Balance", format: webix.i18n.priceFormat, sort: "int", editor: "text" },
                    { id: "registered", header: "Date", format: webix.i18n.fullDateFormatStr, sort: "date", editor: "date" },
                    {
                        id: "friends", header: "Refs", template: function (obj, common) {
                            return obj.friends.length

                        }
                    },
                    { id: "Delete", template: "{common.trashIcon()}" },
                ]
            }]

        });

    </script>
</body>

</html>